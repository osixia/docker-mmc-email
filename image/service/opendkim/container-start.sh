#!/bin/bash -e

FIRST_START_DONE="/etc/docker-opendkim-first-start-done"

# container first start
if [ ! -e "$FIRST_START_DONE" ]; then

  echo "$HOSTNAME" >> /etc/opendkim/TrustedHosts

  touch $FIRST_START_DONE
fi

#Â delete preexisting autogenerated files
[ -f /etc/opendkim/KeyTable ] || rm -f /etc/opendkim/KeyTable
[ -f /etc/opendkim/SigningTable ] || rm -f /etc/opendkim/SigningTable

touch /etc/opendkim/KeyTable
touch /etc/opendkim/SigningTable

# list mail domains
LDAP_AUTH=""
if [ -n "${MMC_MAIL_LDAP_BIND_DN}" ]; then
  LDAP_AUTH="-D ${MMC_MAIL_LDAP_BIND_DN}"
fi
if [ -n "${MMC_MAIL_LDAP_BIND_PW}" ]; then
  LDAP_AUTH="$LDAP_AUTH -w ${MMC_MAIL_LDAP_BIND_PW}"
fi

# better way ?
HOST_FILE="ldap-hosts"
touch $HOST_FILE

echo "/sbin/setuser root ldapsearch -x -H ${MMC_MAIL_LDAP_URL} -b ${MMC_MAIL_LDAP_BASE_DN} \"(&(objectClass=mailDomain)(virtualdomain=*))\" ${LDAP_AUTH}"
/sbin/setuser root ldapsearch -x -H ${MMC_MAIL_LDAP_URL} -b ${MMC_MAIL_LDAP_BASE_DN} "(&(objectClass=mailDomain)(virtualdomain=*))" ${LDAP_AUTH} | grep "virtualdomain:" > ${HOST_FILE} || true
sed -i "s/virtualdomain: //g" $HOST_FILE

for domain in $(cat $HOST_FILE);
do

  echo "Domain: $domain"

  # the domain private key doesn't exists -> generate one
  if [ ! -f "/container/service/opendkim/assets/keys/$domain.key" ]; then

    echo "-> key not found, generating one"
    opendkim-genkey --domain=$domain --append-domain --selector=$MMC_MAIL_OPENDKIM_SELECTOR --directory /container/service/opendkim/assets/keys

    echo "-> add the following DNS entry:"
    cat /container/service/opendkim/assets/keys/mail.txt

    mv /container/service/opendkim/assets/keys/mail.private /container/service/opendkim/assets/keys/$domain.key
    mv /container/service/opendkim/assets/keys/mail.txt /container/service/opendkim/assets/keys/$domain.txt
  fi

  echo "$MMC_MAIL_OPENDKIM_SELECTOR._domainkey.$domain. $domain:$MMC_MAIL_OPENDKIM_SELECTOR:/container/service/opendkim/assets/keys/$domain.key" >> /etc/opendkim/KeyTable
  echo "*@$domain $MMC_MAIL_OPENDKIM_SELECTOR._domainkey.$domain." >> /etc/opendkim/SigningTable
  echo "$domain" >> /etc/opendkim/TrustedHosts
  echo "*.$domain" >> /etc/opendkim/TrustedHosts

done

rm -f $HOST_FILE

chmod 755 /container/service/opendkim/assets/keys
chmod 600 /container/service/opendkim/assets/keys/*
chown opendkim:opendkim -R /container/service/opendkim/assets/keys
chown opendkim:opendkim -R /etc/opendkim
